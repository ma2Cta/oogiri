# 大喜利アプリケーション 仕様書（更新版）

## 1. 概要
このアプリケーションは、友人同士でカジュアルに楽しめる大喜利プラットフォームを提供することを目的としています。スマートフォンに対応したウェブアプリケーションとして開発され、ネイティブアプリではなく、ウェブブラウザからアクセスできる形式です。

## 2. システム構成
- **フロントエンド**: Next.js（TypeScript）、Tailwind CSS、shadcn/ui
- **バックエンド**: Rust（AWS Lambda上で動作）
  - **フレームワーク**: `aws-lambda-rust-runtime`、`lambda_http`
- **データベース**: AWS DynamoDB
- **インフラストラクチャ**: AWS S3、CloudFront、AWS Lambda、AWS API Gateway
- **AIサービス**: OpenAI API

## 3. 機能仕様

### 3.1 お題生成機能
- **概要**: OpenAI APIを利用して大喜利のお題を自動生成します。
- **詳細**:
  - ゲーム開始時にお題を生成。
  - お題はテキスト形式で提供。
  - エラーハンドリング: API呼び出し失敗時にはデフォルトのお題を使用。

### 3.2 回答機能
- **概要**: ユーザーはテキストベースでお題に対して回答を入力できます。
- **詳細**:
  - テキスト入力のみ対応。
  - 各ユーザーは一度だけ回答可能。
  - 回答の提出状況をリアルタイムで表示。
  - エラーハンドリング: 回答の送信失敗時には再試行オプションを提供。

### 3.3 投票機能
- **概要**: 参加者全員が回答後、それぞれの回答に投票します。
- **詳細**:
  - 自分以外の回答に対して投票可能。
  - 投票結果はリアルタイムで集計。
  - エラーハンドリング: 投票の送信失敗時には再試行オプションを提供。

### 3.4 結果表示機能
- **概要**: 投票結果を集計し、順位を表示します。
- **詳細**:
  - 得票数に基づいてランキングを作成。
  - 同票の場合は同順位とする。
  - エラーハンドリング: 結果表示の失敗時には再試行オプションを提供。

### 3.5 ゲーム管理機能
- **概要**: ゲームの開始から終了までを管理します。
- **詳細**:
  - ゲームの作成、参加、進行状況を管理。
  - ゲームごとに一意の識別子（`GameID`）を生成。
  - エラーハンドリング: ゲーム作成や参加の失敗時には再試行オプションを提供。

### 3.6 ユーザー識別機能
- **概要**: ログインなしでユーザーを一意に識別します。
- **詳細**:
  - クライアントサイドでUUIDを生成し、`UserID`として使用。
  - `UserID`はCookieやLocalStorageに保存。
  - サーバー通信時に`UserID`を含めてリクエスト。

## 4. 非機能仕様

### 4.1 パフォーマンス要件
- **応答時間**: ユーザー操作に対して3秒以内の応答を目標とする。
- **同時接続数**: 最大10人程度の小規模なグループを想定。

### 4.2 セキュリティ要件
- **認証・認可**: ユーザーログインなしで利用可能。
- **データ保護**: ユーザーの回答や投票は匿名で扱う。

### 4.3 可用性要件
- **稼働時間**: AWSのサーバーレスアーキテクチャを利用し、高い可用性を確保。

## 5. 技術仕様

### 5.1 フロントエンド
- **フレームワーク**: Next.js（TypeScript）
- **スタイル**: Tailwind CSS、shadcn/ui
- **ユーザー識別**:
  - 初回アクセス時にUUIDを生成し、`UserID`としてCookieまたはLocalStorageに保存。
- **デプロイ**: 静的ファイルをビルドし、AWS S3とCloudFrontで配信。

### 5.2 バックエンド
- **言語**: Rust
- **実行環境**: AWS Lambda（サーバーレス）
- **フレームワーク**: `aws-lambda-rust-runtime`、`lambda_http`
- **API管理**: AWS API Gatewayを利用
- **機能**:
  - お題生成（OpenAI APIとの連携）
  - 回答と投票の受け取りと保存
  - ゲーム進行の管理
  - ユーザー識別の管理（`UserID`の受け取りと検証）

### 5.3 データベース
- **データストア**: AWS DynamoDB
- **設計**:
  - **Gamesテーブル**:
    - パーティションキー: `GameID`（文字列）
    - 属性: お題、開始時間、終了時間、ステータス
  - **Answersテーブル**:
    - パーティションキー: `GameID`（文字列）
    - ソートキー: `UserID`（文字列）
    - 属性: 回答内容、提出時間
  - **Votesテーブル**:
    - パーティションキー: `GameID`（文字列）
    - ソートキー: `AnswerID`（文字列）
    - 属性: 投票者の`UserID`リスト
- **ユーザー識別**:
  - `UserID`はクライアントで生成されたUUIDを使用。

### 5.4 AIサービス
- **利用API**: OpenAI API
- **機能**: 大喜利のお題を生成
- **プロンプト例**: 「ユーモアあふれる大喜利のお題を一つ提供してください。」

### 5.5 CI/CD
- **リポジトリ**: GitHub
- **CI/CDツール**: GitHub Actions
- **プロセス**:
  - コードのプッシュ時に自動ビルドと単体テストを実行
  - 成功時にAWSへの自動デプロイ

### 5.6 開発環境
- **ローカル環境**: Dockerを利用
- **パッケージ管理**:
  - フロントエンド: `npm`（`package.json`）
  - バックエンド: `Cargo`（`Cargo.toml`）

## 6. データモデル

### 6.1 エンティティ定義
- **Game**
  - `GameID`: ゲームの一意識別子
  - お題: テキスト
  - ステータス: `waiting`、`in_progress`、`finished`
  - 開始時間、終了時間
- **Answer**
  - `GameID`
  - `UserID`（クライアントで生成されたUUID）
  - 回答内容
  - 提出時間
- **Vote**
  - `GameID`
  - `AnswerID`
  - 投票者の`UserID`リスト

### 6.2 リレーションシップ
- **Game ↔ Answer**: `GameID`で関連付け
- **Answer ↔ Vote**: `AnswerID`で関連付け

## 7. インフラストラクチャ
- **AWS S3**: フロントエンドの静的ファイルホスティング
- **AWS CloudFront**: グローバルなコンテンツ配信ネットワーク
- **AWS Lambda**: バックエンド処理（`aws-lambda-rust-runtime`、`lambda_http`を使用）
- **AWS API Gateway**: APIエンドポイントの提供
- **AWS DynamoDB**: データストレージ
- **OpenAI API**: お題生成のAIサービス

## 8. テスト戦略

### 8.1 単体テスト
- **バックエンド**:
  - Lambda関数ごとのロジックテスト
  - DynamoDBとのデータ操作のテスト
- **フロントエンド**:
  - コンポーネントのレンダリングテスト
  - ユーザー操作のシミュレーション

### 8.2 テストツール
- **バックエンド**: Rustの標準テストフレームワーク
- **フロントエンド**: Jest、React Testing Library
